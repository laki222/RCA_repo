@{
    List<RedditService.Models.PostEntity> posts = ViewBag.Posts;
    List<RedditService.Models.CommentEntity> comments = ViewBag.Comments;
    int currentPage = ViewBag.CurrentPage ?? 1;
    var klik = ViewBag.ButtonClick;
    var clickedPostRowKey = ViewBag.ClickedPostRowKey;
    var EmailOwnerPost = ViewBag.EmailOwnerPost;
    var react = ViewBag.react;
    var currentSortBy = ViewBag.CurrentSortBy ?? "";
    var currentSortOrder = ViewBag.CurrentSortOrder ?? "";
    var titleFilter = ViewBag.TitleFilter ?? "";
}

<script src="https://use.fontawesome.com/2903eb4599.js"></script>
<link href="~/Content/Feed.css" rel="stylesheet" type="text/css" />

<div style="position: relative;">
    <div id="createPostContainer">
        @Html.Partial("_CreatePostPartial")
    </div>
    <a id="toggleCreatePostButton" class="create-post-button" href="#createPostContainer" asp-action="ShowCreatePost">
        <i class="fa fa-plus"></i> Create Post
    </a>
</div>

<h1>SEARCH</h1>
<form action="@Url.Action("Sort", "Feed")" method="get" style="display:inline;">
    <input type="text" name="titleFilter" value="@titleFilter" />
    <button type="submit">
        <i class="fa fa-search" style="font-size: 1.2em;"></i>
    </button>
    <input type="hidden" name="sortBy" value="@currentSortBy" />
    <input type="hidden" name="sortOrder" value="@currentSortOrder" />
</form>

<form action="@Url.Action("Sort", "Feed")" method="get" style="display:inline;">
    <input type="hidden" name="titleFilter" value="@titleFilter" />
    <select name="sortBy">
        <option value="">Sort by</option>
        <option value="title" @(currentSortBy == "title" ? "selected" : "")>Title</option>
        <option value="upvotes" @(currentSortBy == "upvotes" ? "selected" : "")>Upvotes</option>
    </select>
    <button type="submit" name="sortOrder" value="ascending" @(currentSortOrder == "ascending" ? "selected" : "")>
        <i class="fa fa-arrow-up"></i>
    </button>
    <button type="submit" name="sortOrder" value="descending" @(currentSortOrder == "descending" ? "selected" : "")>
        <i class="fa fa-arrow-down"></i>
    </button>
</form>

<div class="card-list">
    @foreach (var p in ViewBag.PaginatedPosts)
    {
        if (!p.IsDeleted)
        {
            <article class="card">
                <figure class="card-image">
                    <img src="@p.ImageUrl" alt="@p.Title" />
                </figure>
                <div class="card-header">
                    <a href="#">@p.Title</a>
                </div>
                <p>@p.Content</p>
                <div class="card-footer">
                    <div class="card-meta card-meta--views">
                        <div class="@(react == "up" ? "liked" : "")">
                            <form action="@Url.Action("LikePost", "Feed")" method="post" style="display:inline;">
                                <input type="hidden" name="rowkey" value="@p.RowKey" />
                                <input type="hidden" name="isUpvote" value="true" />
                                <a href="#" class="like" onclick="this.closest('form').submit(); return false;">
                                    <i class="fa fa-thumbs-o-up"></i>
                                    <input class="qty1" name="qty1" type="text" value="@p.Upvotes" readonly />
                                </a>
                            </form>
                        </div>
                        <div class="@(react == "down" ? "disliked" : "")">
                            <form action="@Url.Action("LikePost", "Feed")" method="post" style="display:inline;">
                                <input type="hidden" name="rowkey" value="@p.RowKey" />
                                <input type="hidden" name="isUpvote" value="false" />
                                <a href="#" class="dislike" onclick="this.closest('form').submit(); return false;">
                                    <i class="fa fa-thumbs-o-down"></i>
                                    <input class="qty1" name="qty1" type="text" value="@p.Downvotes" readonly />
                                </a>
                            </form>
                        </div>
                        <form action="@Url.Action("Comments", "Feed")" method="get" style="display:inline;">
                            <input type="hidden" name="rowkey" value="@p.RowKey" />
                            <input type="hidden" name="page" value="@currentPage" />
                            <a href="#" onclick="this.closest('form').submit(); return false;">
                                <i class="fa fa-comments-o"></i>
                            </a>
                        </form>
                    </div>
                </div>

                @if (p.CommentsOpen)
                {
                    <h1>Comments</h1>
                    foreach (var c in comments)
                    {
                        if (c.PostId == p.RowKey && !c.IsDeleted)
                        {
                            <div class="comment">
                                <h6>@c.AuthorEmail</h6>
                                <p>@c.Content</p>
                                @if (p.AuthorEmail == EmailOwnerPost || c.AuthorEmail == EmailOwnerPost)
                                {
                                    <form action="@Url.Action("DeleteComment", "Feed")" method="post" style="display:inline;">
                                        <input type="hidden" name="commentId" value="@c.RowKey" />
                                        <input type="hidden" name="page" value="@currentPage" />
                                        <button type="submit" class="delete-comment">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        }
                    }
                    <div class="comment-section">
                        <h5>Leave a comment</h5>
                        <form action="@Url.Action("AddComment", "Feed")" method="post" class="comment-form">
                            <input type="hidden" name="postId" value="@p.RowKey" />
                            <input type="hidden" name="page" value="@currentPage" />
                            <textarea name="content" placeholder="Add a comment..."></textarea>
                            <button type="submit">Submit</button>
                        </form>
                        <hr />
                    </div>
                }
            </article>
        }
    }
</div>

@if (ViewBag.TotalPages > 1)
{
    <div class="pagination-container">
        <div class="pagination">
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                <a href="?page=@i&sortBy=@currentSortBy&sortOrder=@currentSortOrder&titleFilter=@titleFilter" class="@(ViewBag.CurrentPage == i ? "active" : "")">@i</a>
            }
        </div>
    </div>
}
